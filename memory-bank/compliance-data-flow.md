# Документ комплаенса: Пайплайн обработки данных

**Проект:**  VOICE AGENT ANALITYCS
**Дата:** 2025-11-03  
**Версия:** 1.0

## 1. Общее описание системы

Система предназначена для автоматической обработки и анализа звонков/диалогов от ElevenLabs AI-агентов с последующей интеграцией в CRM-систему БПМсофт.

## 2. Архитектура и поток данных

### 2.1 Схема пайплайна

```
[ElevenLabs Agents] 
    ↓ POST webhook (HTTPS, HMAC SHA-256)
[Сервер на Render.com] 
    ↓ валидация подписи
    ↓ сохранение события
[PostgreSQL БД на Render.com]
    ↓ очередь анализа
[OpenAI API (GPT-4/GPT-5)]
    ↓ LLM-аналитика
[PostgreSQL БД на Render.com]
    ↓ сохранение результата
    ↓ экспорт данных
[БПМсофт CRM]
```

### 2.2 Детальное описание этапов

#### Этап 1: Получение данных от ElevenLabs
- **Источник:** ElevenLabs Agents (https://elevenlabs.io)
- **Метод передачи:** POST webhook через HTTPS
- **Защита:** HMAC SHA-256 подпись (заголовок `ElevenLabs-Signature`)
- **Формат:** JSON
- **Содержимое:**
  - Метаданные разговора (agent_id, conversation_id, timestamp)
  - Транскрипт диалога (роли: user/agent, текст сообщений)
  - Технические флаги (has_audio, has_user_audio, has_response_audio)

#### Этап 2: Обработка на сервере (Render.com)
- **Хостинг:** Render.com (управляемый хостинг, SOC 2 Type II, ISO 27001)
- **Технология:** Node.js 20+, Express framework
- **Процесс:**
  1. Проверка подписи HMAC SHA-256 с секретом WEBHOOK_SECRET
  2. Валидация временного окна (tolerance ±30 минут)
  3. Парсинг JSON и извлечение полей
  4. Сохранение события в БД
  5. Немедленный ответ 200 OK клиенту
  6. Асинхронная постановка в очередь на анализ

#### Этап 3: Хранение данных (PostgreSQL на Render.com)
- **СУБД:** PostgreSQL 14+
- **Хостинг:** Render.com (управляемая БД, автоматические бэкапы, шифрование at-rest)
- **Таблицы:**
  - `webhook_events`: исходные события (id, event_type, event_timestamp, agent_id, conversation_id, payload JSONB, processed, received_at)
  - `analyses`: результаты анализа (id, event_id FK, model, result JSONB, created_at)
- **Безопасность:**
  - Подключение по SSL
  - Ограничение доступа по IP (если доступно)
  - Хранение паролей в переменных окружения

#### Этап 4: LLM-анализ (OpenAI API)
- **Провайдер:** OpenAI (https://openai.com)
- **Модель:** GPT-4 или GPT-5 (настраивается через ANALYZE_MODEL)
- **Метод передачи:** HTTPS REST API (TLS 1.2+)
- **Передаваемые данные:**
  - Транскрипт разговора (обезличенный текст диалога)
  - Системный промпт (инструкции по анализу)
- **Получаемые данные (JSON):**
  - `topic` — тема разговора
  - `intent` — намерение клиента
  - `quality` — оценка качества агента (1-5)
  - `outcome` — исход разговора
  - `summary_ru` — краткий итог
  - `recommendations` — рекомендации
  - `client_name` — имя клиента (если упомянуто)
  - `phone` — телефон клиента (если упомянут)
- **Защита:**
  - API ключ (OPENAI_API_KEY) в переменных окружения
  - Rate limiting через Bottleneck (троттлинг запросов)

#### Этап 5: Сохранение результатов анализа (PostgreSQL)
- **Таблица:** `analyses`
- **Связь:** event_id → webhook_events.id (FK с ON DELETE CASCADE)
- **Формат:** result JSONB (полный JSON с 8 полями)

#### Этап 6: Экспорт в БПМсофт CRM
- **Система:** БПМсофт (bpmsoft / Creatio)
- **Эндпоинт:** `https://office.bir.by:6163/0/ServiceModel/GeneratedObjectWebFormService.svc/SaveWebFormObjectData`
- **Метод:** POST HTTPS
- **Аутентификация:** Basic Auth (опционально, credentials в переменных окружения)
- **Формат запроса:** JSON (массивы fields/contactFields)
- **Передаваемые данные:**
  - `fields`: Commentary, UsrQualificationComment, UsrTSLeadStatus, UsrQualificationTopic, UsrIntent, UsrQualityScore, UsrEventId, UsrAgentId, UsrConversationId
  - `contactFields`: FullName, Phone, Email
  - `landingId`: GUID лендинга (CRM_LANDING_ID)
- **Защита:**
  - HTTPS (TLS)
  - Basic Auth (если настроено)
  - Retry механизм (до 2 попыток при ошибках)
  - Best-effort (не блокирует основной поток)

## 3. Персональные данные (ПДн)

### 3.1 Категории обрабатываемых данных
- **Идентификационные:** имя клиента, телефон
- **Содержание диалога:** текст разговора (может содержать любые данные, упомянутые клиентом)
- **Технические метаданные:** agent_id, conversation_id, timestamp, IP-адрес отправителя

### 3.2 Правовая основа обработки
- Согласие клиента на запись разговора (получается ElevenLabs на стороне клиента)
- Легитимный интерес для улучшения качества обслуживания

### 3.3 Сроки хранения
- **В PostgreSQL:** бессрочно (или до явного удаления администратором)
- **В БПМсофт CRM:** согласно политике хранения CRM-системы
- **В памяти сервера:** временно (до завершения обработки запроса)

### 3.4 Меры защиты
- Шифрование при передаче: HTTPS/TLS 1.2+
- Шифрование at-rest: управляемая БД Render.com (encryption at rest)
- Ограничение доступа: переменные окружения, секреты не в коде
- Логирование: без персональных данных в обычных логах (только debug)
- Подпись вебхука: HMAC SHA-256 для предотвращения подмены

## 4. Безопасность и контроль доступа

### 4.1 Аутентификация и авторизация
- **ElevenLabs → Сервер:** HMAC SHA-256 подпись (секрет WEBHOOK_SECRET)
- **Сервер → OpenAI:** API ключ (OPENAI_API_KEY)
- **Сервер → БД:** PostgreSQL credentials (DATABASE_URL)
- **Сервер → БПМсофт:** Basic Auth (опционально, CRM_BASIC_AUTH_USER/PASS)

### 4.2 Сетевая безопасность
- Все соединения по HTTPS/TLS 1.2+
- Валидация подписи с допуском времени (защита от replay-атак)
- Опциональный IP whitelist для вебхука (конфигурируемо)
- Rate limiting на эндпоинты (Bottleneck, конфигурируемо)

### 4.3 Управление секретами
- Все секреты/ключи в переменных окружения (.env, Render.com Environment Variables)
- Секреты не коммитятся в Git
- Ротация секретов: вручную администратором

### 4.4 Логирование и мониторинг
- Структурированные логи (JSON, консоль → Render.com logs)
- Логирование ошибок валидации подписи (без раскрытия секрета)
- Логирование событий анализа (без полного содержимого диалога в production)
- DEBUG-режим (отключён в production, включается DEBUG=true для отладки)

## 5. Соответствие требованиям

### 5.1 GDPR (если применимо)
- **Право на доступ:** возможность запроса данных по event_id/conversation_id
- **Право на удаление:** возможность удаления события и связанной аналитики (CASCADE)
- **Право на исправление:** возможность обновления записи в БД
- **Уведомление о нарушении:** в течение 72 часов (процедура у администратора)

### 5.2 ISO 27001 / SOC 2
- Render.com: SOC 2 Type II, ISO 27001
- OpenAI: SOC 2, доступна DPA (Data Processing Agreement)
- Управление инцидентами: процедура эскалации к администратору

### 5.3 Локальные требования (РФ/BY)
- Хранение данных: в зависимости от конфигурации Render.com (регион БД)
- При необходимости: миграция на локальный хостинг или регион ЕС/РФ

## 6. Риски и меры снижения

| Риск | Вероятность | Влияние | Меры снижения |
|------|-------------|---------|---------------|
| Утечка WEBHOOK_SECRET | Низкая | Высокое | Ротация секрета, переменные окружения, мониторинг |
| Утечка OPENAI_API_KEY | Низкая | Среднее | Ротация ключа, rate limiting, мониторинг |
| Несанкционированный доступ к БД | Низкая | Высокое | SSL, сильные пароли, IP whitelist |
| DDoS на вебхук | Средняя | Среднее | Rate limiting, Render.com DDoS protection |
| Ошибка LLM (неверная аналитика) | Средняя | Низкое | Проверка качества, A/B тестирование промптов |
| Сбой Render.com | Низкая | Среднее | Fallback в файл (logs/events.jsonl), мониторинг |

## 7. Контакты и ответственность

- **Администратор системы:** [указать ФИО/контакт]
- **DPO (если применимо):** [указать ФИО/контакт]
- **Техническая поддержка:** [указать контакт]

## 8. Изменения и версионность

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 2025-11-03 | Cursor AI / Анатолий | Первичная версия документа |

## 9. Приложения

### A. Переменные окружения (без значений)
```
WEBHOOK_SECRET=<секрет>
WEBHOOK_TOLERANCE_SEC=1800
PORT=3000

DATABASE_URL=postgresql://...

OPENAI_API_KEY=<ключ>
ANALYZE_MODEL=gpt-4 или gpt-5
ANALYZE_AUTO=true
ANALYZE_MAX_CONCURRENCY=1
ANALYZE_MIN_MS=1500

EXTERNAL_CRM_ENABLED=true
CRM_SERVICE_URL=https://office.bir.by:6163/0/ServiceModel/GeneratedObjectWebFormService.svc/SaveWebFormObjectData
CRM_LANDING_ID=<GUID>
CRM_BASIC_AUTH_USER=<опционально>
CRM_BASIC_AUTH_PASS=<опционально>
CRM_TIMEOUT_MS=8000
CRM_MAX_RETRIES=2

CRM_MD_ENABLED=true
CRM_MD_PATH=memory-bank/crm.md

DEBUG=false
```

### B. Диаграмма потока данных (текстовая)
```
┌─────────────────────┐
│ ElevenLabs Agents   │
│ (источник данных)   │
└──────────┬──────────┘
           │ HTTPS POST
           │ HMAC SHA-256
           ↓
┌─────────────────────┐
│ Render.com Server   │
│ Node.js/Express     │
│ - Валидация подписи │
│ - Сохранение в БД   │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐
│ PostgreSQL (Render) │
│ - webhook_events    │
│ - analyses          │
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐
│ OpenAI API          │
│ GPT-4 / GPT-5       │
│ - Анализ транскрипта│
└──────────┬──────────┘
           │
           ↓
┌─────────────────────┐
│ PostgreSQL (Render) │
│ Сохранение result   │
└──────────┬──────────┘
           │
           |
           ↓                 
  ┌──────────────────┐
  │ БПМсофт CRM      │
  │ (API POST HTTPS) │
  └──────────────────┘
```

---

Стоимость - 
render.com сервер - 7$/мес = $84
render.com  - база данных Postgre - 7$/мес = $84
OpenaAI API GPT-5 (тариф OpenAI)
 - 2000 токенов входящих 
 - 500 исходящие  

**Подпись:**  
Дата: 2025-11-03  
Подготовлено:  Анатолий  


