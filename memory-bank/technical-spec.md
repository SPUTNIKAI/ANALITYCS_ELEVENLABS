## Техническое задание (ТЗ)

Проект: Аналитика вебхуков ElevenLabs (ANALITYCS_ELEVENLABS)

Дата: {{ autogenerated }}

### 1. Цели и контекст
- Принять post-call вебхуки от ElevenLabs Agents, верифицировать подпись, сохранять события.
- Выполнять LLM-аналитику транскрипта разговора и хранить результаты.
- Экспортировать краткую аналитику в `memory-bank/crm.md` для операционного использования и согласования.

### 2. Текущее состояние (реализовано)
- HTTP-сервер Node.js/Express (`src/server.js`).
- Эндпоинт: `POST /webhook/elevenlabs` с проверкой подписи `ElevenLabs-Signature` (HMAC SHA-256 по строке `${timestamp}.${rawBody}`, допуск времени `WEBHOOK_TOLERANCE_SEC`).
- Сырой `rawBody` читается через `body-parser.raw` только для пути вебхука.
- Сохранение событий в PostgreSQL (таблица `webhook_events`) при наличии `DATABASE_URL`; при недоступности БД — фалбэк в `logs/events.jsonl`.
- Поля события учитывают флаги: `has_audio`, `has_user_audio`, `has_response_audio`.
- Очередь LLM-аналитики на Bottleneck, автоанализ свежего события в фоне (фича-флаг `ANALYZE_AUTO`).
- LLM-анализ через OpenAI SDK (`src/analysis.js`), результат — JSON с ключами: `topic`, `intent`, `quality`, `outcome`, `summary_ru`, `recommendations`. Результаты хранятся в таблице `analyses`.
- Экспорт результата анализа в `memory-bank/crm.md` (best-effort) через `src/crmWriter.js` (включается `CRM_MD_ENABLED`).
- Ручные роуты анализа: `POST /api/analyze` (анализ конкретного события), `POST /api/analyze/next` (анализ следующего необработанного).
- Документация Memory Bank и README обновлены; переменные окружения описаны.

### 3. Что ещё необходимо сделать (бэклог)
3.1 Надёжность и идемпотентность
- Идемпотентность при вставке событий: уникальный ключ по `event_id` (если доступен) либо по хэшу `rawBody`+`timestamp` (в окне), с «мягким» upsert.
- Механизм ретраев LLM при временных ошибках (экспоненциальная задержка, ограничение попыток).
- DLQ/метка для необработанных из-за ошибок событий; ручной триггер повторной обработки.

3.2 Безопасность
- IP whitelisting источников ElevenLabs (конфигурируемые подсети); отчёт в логах при отклонении.
- Rate limiting на вебхук и админ-роуты.
- Audit-лог ключевых действий (перепроцессинг, админ-доступ).

3.3 Наблюдаемость
- Структурированные логи с correlation/request id.
- Метрики (basic): количество событий, ошибки валидации, среднее время анализа, доля ретраев.

3.4 Админ/операционные возможности (API)
- `GET /api/events?filters` — список событий с пагинацией/фильтрами.
- `GET /api/events/:id` — подробности события и связанной аналитики.
- `POST /api/events/:id/reprocess` — перепроцессинг события.
- `GET /api/health/full` — расширенная проверка (БД, ключи, лимитеры).

3.5 Тестирование
- Unit: подпись, парсинг заголовка, вычисление HMAC, транспиляция транскрипта.
- Integration: полный путь вебхука (валид/невалид подпись), запись в БД, автоанализ, запись в CRM md.
- Нагрузочный (легкий): 50–200 последовательных вебхуков с контролем rate limiting.

3.6 Деплой/операции
- Dockerfile + докер-компоуз для локальной БД.
- CI (lint, тесты, сборка образа).
- Шаблоны окружений: `.env.example` с описанием.

### 4. Требования (функциональные)
- Приём `POST /webhook/elevenlabs` с HMAC-подписью и допуском времени.
- Сохранение события (включая `payload` и аудиофлаги), логирование при фалбэке на файл.
- Автоматический анализ (если включено) + ручной анализ через `/api`.
- Запись результата анализа в БД и `memory-bank/crm.md`.
- Идемпотентность при повторных доставках.
- Ручной репроцессинг единичного события.

### 5. Требования (нефункциональные)
- Доступность: ≥ 99% для приёма вебхуков.
- Производительность: обработка вебхука ≤ 200 мс до ответа (без ожидания LLM).
- Безопасность: подпись, опциональный IP whitelist, rate limiting.
- Наблюдаемость: структурированные логи, базовые метрики.

### 6. Интерфейсы API (кратко)
- `POST /webhook/elevenlabs` — входящий вебхук (JSON, заголовок `ElevenLabs-Signature`).
- `POST /api/analyze` — body: `{ event: <row> }` → результат анализа.
- `POST /api/analyze/next` — анализ первого необработанного.
- (План) `GET /api/events` / `GET /api/events/:id` / `POST /api/events/:id/reprocess` / `GET /api/health/full`.

### 7. Модель данных (БД)
- `webhook_events(id, event_type, event_timestamp, agent_id, conversation_id, status, has_audio, has_user_audio, has_response_audio, payload, processed, processed_at, processor_note, received_at)`
- `analyses(id, event_id, model, result, created_at)`
- (План) Индекс/уникальное ограничение для идемпотентности по `event_id` или хэшу.

### 8. Переменные окружения
- `WEBHOOK_SECRET`, `WEBHOOK_TOLERANCE_SEC`, `PORT`
- `DATABASE_URL`
- `OPENAI_API_KEY`, `ANALYZE_MODEL`, `ANALYZE_AUTO`, `ANALYZE_MAX_CONCURRENCY`, `ANALYZE_MIN_MS`
- `CRM_MD_ENABLED`, `CRM_MD_PATH`

### 9. Тест-критерии приёмки
- Вебхук с валидной подписью → 200 OK, событие в БД (или файл), при включённом автоанализе — запись в `analyses` и CRM md.
- Невалидная подпись → 401, событие не сохраняется в БД.
- Повторная доставка того же события → дубликат не создаётся (идемпотентность), логируется как повтор.
- Ручной анализ `/api/analyze` возвращает структурированный JSON и пишет в БД + CRM md.

### 10. Риски и допущения
- ElevenLabs может менять формат полезной нагрузки — предусмотреть расширяемый парсер.
- `event_id` может отсутствовать — потребуется стратегия идемпотентности на основе хэша.
- Квоты/лимиты OpenAI — требуется троттлинг и ретраи.

### 11. Оценка трудозатрат (часы)
Оценка с учётом разработки в Cursor AI и наличия готовых модулей (ускорение ~25–35%):
- Идемпотентность (уник. ключ/хэш, upsert, миграция): 4–6 ч
- Ретраи LLM + DLQ/метки: 3–5 ч
- IP whitelist + rate limiting: 3–4 ч
- Расширенная наблюдаемость (структ. логи, request id, базовые метрики): 3–4 ч
- Админ-роуты (список/детали/репроцессинг/health): 6–10 ч
- Тестирование (unit/integration, генератор подписи): 8–12 ч
- Dockerfile + docker-compose (локальная БД), CI: 4–6 ч
- Документация (операционная, обновление README/MB): 2–3 ч
- Буфер рисков и UAT: 4–6 ч

Итого (remaining): ~37–56 ч

Опционально (вне базового скоупа):
- Интеграция с внешним CRM API (БПМсофт/bpmsoft): 10–18 ч (дополнительная аналитика и поля CRM)
- Простая HTML-страница статуса/дашборд: 2 ч

Полная оценка «с нуля» (для справки): 50 ч (c внешним CRM).

#### 11.1 Разбивка по блокам и суммарная оценка

- Блок A — Приём данных от ElevenLabs (вебхук): 9–14 ч
  - Валидация подписи, толеранс времени, идемпотентность (ключ/хэш, upsert)
  - Безопасность: IP whitelist + rate limiting
  - Тесты (unit/integration) пути вебхука

- Блок B — LLM-аналитика и сохранение в БД: 12–18 ч
  - Очередь, ретраи, DLQ/метки необработанных
  - Схема БД/индексы, базовые админ-роуты
  - Тесты аналитики и записи

- Блок C — Отправка в CRM БПМсофт (bpmsoft): 5–8 ч
  - Маппинг `fields/contactFields`, таймауты/ретраи
  - ENV/документация
  - E2E на тестовом стенде

- Сквозные задачи: 9–12 ч
  - Наблюдаемость (структурированные логи, request id, базовые метрики)
  - Docker/Compose + CI
  - Документация/операционные инструкции, UAT

Итого (пересчитано): ~35–52 ч

#### 11.2 Согласованная оценка
- Диапазон для согласования: 35–40 ч
- Ориентир: 37 ч

### 12. Поставляемые артефакты
- Исходный код сервера с эндпоинтами и LLM-пайплайном.
- Схема БД и миграции.
- Докер-окружение для локального запуска.
- Набор тестов и инструкции.
- Обновлённый Memory Bank и README.



Зависит от доступности окружений и внешних согласований.


