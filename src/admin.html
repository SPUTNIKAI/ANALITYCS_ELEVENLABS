<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ó–∞–ø–∏—Å–∏ –∑–≤–æ–Ω–∫–æ–≤ ‚Äî –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</title>
  <style>
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;line-height:1.4;margin:0;background:#f7f7f8;color:#0f172a}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .header{padding:16px 20px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between}
    .filters{display:flex;gap:8px;align-items:center}
    .filters input{border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px}
    .filters button{border:1px solid #d1d5db;background:#0ea5e9;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .filters button.secondary{background:#fff;color:#111827}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px}
    th{font-weight:600;color:#475569;background:#f8fafc}
    tr:hover{background:#f9fafb}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid transparent;font-size:12px}
    .q-red{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    .q-blue{background:#dbeafe;color:#1e3a8a;border-color:#bfdbfe}
    .q-green{background:#dcfce7;color:#166534;border-color:#bbf7d0}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:center;justify-content:center;padding:16px}
    .modal .panel{background:#fff;border-radius:12px;max-width:900px;width:100%;max-height:90vh;overflow:auto;border:1px solid #e5e7eb}
    .panel .title{padding:14px 18px;border-bottom:1px solid #e5e7eb;font-weight:600}
    .panel .body{padding:16px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px;margin-bottom:8px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;white-space:pre-wrap;background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:12px}
  </style>
  <script>
    async function fetchList(){
      const dateFrom = document.getElementById('dateFrom').value;
      const dateTo = document.getElementById('dateTo').value;
      const params = new URLSearchParams({ page:'1', limit:'20' });
      if(dateFrom) params.set('dateFrom', dateFrom);
      if(dateTo) params.set('dateTo', dateTo);
      const res = await fetch(`/api/events?${params.toString()}`);
      const data = await res.json();
      renderTable(data.data||[]);
    }
    function fmtDate(ts){
      if(!ts) return '';
      try{ const d=new Date(ts*1000); return d.toLocaleString('ru-RU'); }catch(_){ return String(ts); }
    }
    function qualityBadge(v){
      if(v==null) return '';
      const n = Number(v);
      if(n<=2) return '<span class="badge q-red">'+n+'</span>';
      if(n===3) return '<span class="badge q-blue">'+n+'</span>';
      return '<span class="badge q-green">'+n+'</span>';
    }
    function renderTable(rows){
      const tbody = document.getElementById('tbody');
      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fmtDate(r.event_timestamp)}</td>
          <td>${r.agent_id||''}</td>
          <td>${r.topic||''}</td>
          <td>${qualityBadge(r.quality)||''}</td>
          <td>${r.outcome||''}</td>
          <td>${r.client_name||''}</td>
          <td>${r.phone||''}</td>
        `;
        tr.style.cursor='pointer';
        tr.onclick=()=>openDetails(r.id);
        tbody.appendChild(tr);
      });
    }
    async function openDetails(id){
      const res = await fetch(`/api/events/${id}`);
      const { event, analysis } = await res.json();
      const el = document.getElementById('modal');
      const body = document.getElementById('modal-body');
      const transcript = Array.isArray(event?.payload?.data?.transcript)
        ? event.payload.data.transcript.map(x=>`[${x.role}] ${x.message}`).join('\n')
        : '';
      body.innerHTML = `
        <div class="kv"><div>Event ID</div><div>${event.id}</div></div>
        <div class="kv"><div>–î–∞—Ç–∞/–≤—Ä–µ–º—è</div><div>${fmtDate(event.event_timestamp)}</div></div>
        <div class="kv"><div>Agent ID</div><div>${event.agent_id||''}</div></div>
        <div class="kv"><div>Conversation ID</div><div>${event.conversation_id||''}</div></div>
        <div class="kv"><div>–ê—É–¥–∏–æ —Ñ–ª–∞–≥–∏</div><div>has_audio=${String(event.has_audio)}; user=${String(event.has_user_audio)}; resp=${String(event.has_response_audio)}</div></div>
        <div class="kv"><div>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div><div>
          topic=${analysis?.result?.topic||''}; intent=${analysis?.result?.intent||''};
          quality=${analysis?.result?.quality??''}; outcome=${analysis?.result?.outcome||''};
          client=${analysis?.result?.client_name||''}; phone=${analysis?.result?.phone||''}
        </div></div>
        <div class="kv"><div>–†–µ–∑—é–º–µ (ru)</div><div>${analysis?.result?.summary_ru||''}</div></div>
        <div class="kv"><div>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div><div>${analysis?.result?.recommendations||''}</div></div>
        <div style="margin-top:12px;margin-bottom:6px;font-weight:600">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</div>
        <div class="mono">${transcript?transcript.replace(/</g,'&lt;'):'(–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö)'} </div>
      `;
      el.style.display='flex';
    }
    function closeModal(){ document.getElementById('modal').style.display='none'; }
    window.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('apply').addEventListener('click', fetchList);
      document.getElementById('reset').addEventListener('click', ()=>{document.getElementById('dateFrom').value='';document.getElementById('dateTo').value='';fetchList();});
      fetchList();
    });
  </script>
</head>
<body>
  <div class="container">
    <div style="background:#e0f2fe;border:1px solid #0ea5e9;border-radius:8px;padding:16px;margin-bottom:24px;text-align:center">
      <h2 style="color:#0c4a6e;margin:0 0 8px 0">üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ—Å—Ç—É–ø–µ–Ω!</h2>
      <p style="color:#0369a1;margin:0 0 12px 0">–ú—ã —Å–æ–∑–¥–∞–ª–∏ –Ω–æ–≤—ã–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–∏–¥–∞–º–∏ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ø–æ–∏—Å–∫–æ–º.</p>
      <a href="/leads" style="background:#0ea5e9;color:white;padding:8px 16px;border-radius:6px;text-decoration:none;display:inline-block">–û—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ª–∏–¥–æ–≤ ‚Üí</a>
    </div>
    <div class="card">
      <div class="header">
        <div>–ó–∞–ø–∏—Å–∏ –∑–≤–æ–Ω–∫–æ–≤ (20 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ)</div>
        <div class="filters">
          <input type="date" id="dateFrom" />
          <input type="date" id="dateTo" />
          <button id="apply">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
          <button id="reset" class="secondary">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
      </div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>–î–∞—Ç–∞/–≤—Ä–µ–º—è</th>
              <th>Agent ID</th>
              <th>–¢–µ–º–∞</th>
              <th>–ö–∞—á–µ—Å—Ç–≤–æ</th>
              <th>–ò—Å—Ö–æ–¥</th>
              <th>–ö–ª–∏–µ–Ω—Ç</th>
              <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <div id="modal" class="modal" onclick="if(event.target.id==='modal'){closeModal()}">
    <div class="panel">
      <div class="title">–î–µ—Ç–∞–ª–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ <button style="float:right;border:1px solid #e5e7eb;background:#fff;padding:4px 8px;border-radius:8px;cursor:pointer" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>
      <div id="modal-body" class="body"></div>
    </div>
  </div>
</body>
</html>


